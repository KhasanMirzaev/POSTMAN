name: Postman Tests with Telegram Notification

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ... your existing test execution steps ...

      - name: Upload Test Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: output.log  # Replace with your test results file path

      - name: Download Test Results Artifact
        uses: actions/download-artifact@v4
        with:
          name: test-results

      - name: Process and Format Results
        run: |
          # Download the test results (assuming downloaded to 'output.log')
          TEST_RESULTS=$(cat output.log)  

          # Extract total tests, failures, and errors (adjust patterns if needed)
          TOTAL_TESTS=$(echo "$TEST_RESULTS" | grep 'Tests run:' | awk '{print $2}')
          FAILURES=$(echo "$TEST_RESULTS" | grep 'Failures:' | awk '{print $2}')
          ERRORS=$(echo "$TEST_RESULTS" | grep 'Errors:' | awk '{print $2}')

          # Extract test status (assuming success if no failures or errors)
          TEST_STATUS="Failed"
          if [[ "$FAILURES" == "0" && "$ERRORS" == "0" ]]; then
            TEST_STATUS="Passed"
          fi

          curl -X POST https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="Test Results: $TEST_STATUS \n**Total:** $TOTAL_TESTS, **Failed:** $FAILURES, **Errors:** $ERRORS \n**See full log for details:** [output.log](https://github.com/<username>/<repository>/actions/runs/<run_id>/logs)"

      - name: Send Test Results to Telegram
        run: |
          curl -X POST https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="Test Results: $TEST_STATUS \n**Passed:** $PASSED_TESTS, **Failed:** $FAILED_TESTS \n**See full log for details:** [output.log](https://github.com/<username>/<repository>/actions/runs/<run_id>/logs)"
